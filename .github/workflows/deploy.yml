name: Deploy to Production Server

on:
  push:
    branches:
      - main
  workflow_dispatch: # Allows manual triggering from GitHub UI

jobs:
  deploy:
    name: Deploy to ersin.home.ro
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        run: npm run lint
        continue-on-error: true # Don't fail deployment on lint errors

      - name: Build application
        run: npm run build

      - name: Deploy to server via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          script: |
            # Create directory if it doesn't exist
            sudo mkdir -p /var/www/ersin-site
            sudo chown -R $USER:$USER /var/www/ersin-site
            
            # Create log directory if it doesn't exist
            sudo mkdir -p /var/log/pm2
            sudo chown -R $USER:$USER /var/log/pm2
            
            cd /var/www/ersin-site
            
            # Check if this is first-time deployment
            if [ ! -d ".git" ]; then
              echo "=== First-time deployment: Cloning repository ==="
              git clone https://github.com/alyersin/ersin.site.git .
            else
              echo "=== Updating existing deployment ==="
              # Pull latest changes
              git fetch origin
              git reset --hard origin/main
            fi
            
            # Install dependencies
            npm ci --production
            
            # Build application
            npm run build
            
            # Stop existing process if running
            pm2 delete ersin-site 2>/dev/null || true
            
            # Start PM2
            pm2 start ecosystem.config.js
            
            # Wait for app to start
            sleep 5
            
            # Show status
            pm2 status
            pm2 list
            
            # Show recent logs
            echo "=== PM2 Logs ==="
            pm2 logs ersin-site --lines 30 --nostream || true
            
            # Check if process is running
            if ! pm2 list | grep -q "ersin-site.*online"; then
              echo "ERROR: Application failed to start!"
              pm2 logs ersin-site --lines 50 --nostream
              exit 1
            fi

      - name: Verify deployment
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          script: |
            echo "=== Checking PM2 Status ==="
            pm2 list
            
            echo "=== Checking if app is running ==="
            if ! pm2 list | grep -q "ersin-site.*online"; then
              echo "ERROR: Application is not online!"
              echo "=== PM2 Error Logs ==="
              pm2 logs ersin-site --err --lines 50 --nostream || true
              echo "=== PM2 Output Logs ==="
              pm2 logs ersin-site --out --lines 50 --nostream || true
              exit 1
            fi
            
            echo "=== Checking port 3000 ==="
            netstat -tlnp | grep 3000 || ss -tlnp | grep 3000 || echo "Port 3000 not found in netstat/ss"
            
            echo "=== Testing application response ==="
            # Wait a bit more for app to fully start
            sleep 5
            
            # Try curl with verbose output
            if curl -f -v http://localhost:3000; then
              echo "✅ Application is responding!"
            else
              echo "❌ Application is not responding on port 3000"
              echo "=== PM2 Logs (last 50 lines) ==="
              pm2 logs ersin-site --lines 50 --nostream || true
              echo "=== Checking process ==="
              ps aux | grep -i next || ps aux | grep node
              exit 1
            fi

